generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id                         String       @id @default(auto()) @map("_id") @db.ObjectId
  fullName                   String
  email                      String       @unique
  password                   String?
  phoneNumber                String?
  role                       UserRoleEnum @default(CUSTOMER)
  status                     UserStatus   @default(PENDING)
  isVerified                 Boolean      @default(false)
  isProfileComplete          Boolean      @default(false)
  address                    String?
  latitude                   Float?
  longitude                  Float?
  isLoggedIn                 Boolean      @default(false)
  bio                        String?
  image                      String?
  dateOfBirth                String?
  gender                     String?
  fcmToken                   String?
  fcmTokenEx                 String?
  isDeleted                  Boolean      @default(false)
  isVerifiedForPasswordReset Boolean      @default(false)
  createdAt                  DateTime     @default(now())
  updatedAt                  DateTime     @updatedAt

  // Relationships
  admin          Admin?
  carPlates      CarPlate[]
  cafes          Cafe[]
  orders         Order[]
  loyaltyStamps  LoyaltyStamp[]
  refundRequests RefundRequest[]
  branches       Branch[]
  menuCategories MenuCategory[]
  menuItems      MenuItem[]
  menuItemAddons MenuItemAddon[]
  discounts      Discount[]

  @@map("users")
}

model Admin {
  id           String       @id @default(auto()) @map("_id") @db.ObjectId
  userId       String       @unique @db.ObjectId
  role         UserRoleEnum @default(SUPER_ADMIN)
  isSuperAdmin Boolean      @default(false)
  systemOwner  Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id])

  @@map("admins")
}

model CarPlate {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  plate     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id])

  @@unique([userId, plate])
  @@map("car_plates")
}

//////////////////////////////
// CAFÃ‰ / SHOP
//////////////////////////////

model Cafe {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  ownerId       String   @db.ObjectId
  shopName      String
  licenseNumber String
  contactEmail  String
  contactPhone  String
  description   String?
  logo          String?
  licenseImage  String?
  serviceFee    Float    @default(0.0)
  paymentFee    Float    @default(0.0)
  termsAccepted Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships
  owner         User           @relation(fields: [ownerId], references: [id])
  branches      Branch[]
  promotions    Promotion[]
  loyaltyStamps LoyaltyStamp[]

  @@map("cafes")
}

model Branch {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  ownerId         String   @db.ObjectId
  cafeId          String   @db.ObjectId
  branchName      String
  branchPhone     String
  address         String
  latitude        Float
  longitude       Float
  arrivalRadius   Float // meters
  supportsCar     Boolean  @default(true)
  supportsCounter Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  cafe           Cafe           @relation(fields: [cafeId], references: [id])
  owner          User           @relation(fields: [ownerId], references: [id])
  menuCategories MenuCategory[]
  orders         Order[]

  @@map("branches")
}

//////////////////////////////
// MENU
//////////////////////////////

model MenuCategory {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  ownerId       String   @db.ObjectId
  branchId      String   @db.ObjectId
  categoryName  String
  categoryImage String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships
  branch Branch     @relation(fields: [branchId], references: [id])
  owner  User       @relation(fields: [ownerId], references: [id])
  items  MenuItem[]

  @@unique([branchId, categoryName])
  @@map("menu_categories")
}

model MenuItem {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  ownerId     String   @db.ObjectId
  categoryId  String   @db.ObjectId
  itemName    String
  itemImage   String?
  description String?
  price       Float
  quantity    Int
  isAvailable Boolean  @default(true)
  isCoffee    Boolean  @default(false) // for loyalty
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  category       MenuCategory    @relation(fields: [categoryId], references: [id])
  owner          User            @relation(fields: [ownerId], references: [id])
  orderItems     OrderItem[]
  discounts      Discount[]
  menuItemAddons MenuItemAddon[]

  @@unique([categoryId, itemName])
  @@map("menu_items")
}

model MenuItemAddon {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  ownerId    String   @db.ObjectId
  menuItemId String   @db.ObjectId
  addonName  String
  price      Float
  required   Boolean  @default(false)
  optional   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relationships
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])
  owner    User     @relation(fields: [ownerId], references: [id])

  @@unique([menuItemId, addonName])
  @@map("menu_item_addons")
}

model Discount {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  ownerId   String   @db.ObjectId
  itemId    String   @db.ObjectId
  event     String
  title     String
  percent   Float
  startDate DateTime
  endDate   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  item  MenuItem @relation(fields: [itemId], references: [id])
  owner User     @relation(fields: [ownerId], references: [id])

  @@map("discounts")
}

//////////////////////////////
// ORDER
//////////////////////////////

model Order {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  userId        String        @db.ObjectId
  branchId      String        @db.ObjectId
  totalAmount   Float
  pickupMethod  PickupMethod
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  carPlate      String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relationships
  user   User           @relation(fields: [userId], references: [id])
  branch Branch         @relation(fields: [branchId], references: [id])
  items  OrderItem[]
  refund RefundRequest?

  @@map("orders")
}

model OrderItem {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  orderId    String @db.ObjectId
  menuItemId String @db.ObjectId
  quantity   Int
  price      Float
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  order    Order    @relation(fields: [orderId], references: [id])
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])

  @@map("order_items")
}

//////////////////////////////
// LOYALTY
//////////////////////////////

model LoyaltyStamp {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  cafeId String @db.ObjectId
  stamps Int    @default(0)

  user User @relation(fields: [userId], references: [id])
  cafe Cafe @relation(fields: [cafeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, cafeId])
  @@map("loyalty_stamps")
}

//////////////////////////////
// REFUNDS
//////////////////////////////

model RefundRequest {
  id        String       @id @default(auto()) @map("_id") @db.ObjectId
  orderId   String       @db.ObjectId
  userId    String       @db.ObjectId
  reason    String
  penalty   Float?
  status    RefundStatus @default(REQUESTED)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relationships
  order Order @relation(fields: [orderId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@map("refund_requests")
}

//////////////////////////////
// MARKETING
//////////////////////////////

model Promotion {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  cafeId    String        @db.ObjectId
  itemId    String?       @db.ObjectId
  tier      PromotionTier
  startDate DateTime
  endDate   DateTime
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relationships
  cafe Cafe @relation(fields: [cafeId], references: [id])

  @@map("promotions")
}

enum UserRoleEnum {
  ADMIN
  SUPER_ADMIN
  SHOP_OWNER
  CUSTOMER
}

enum PickupMethod {
  CAR
  COUNTER
}

enum OrderStatus {
  PENDING
  PREPARING
  READY
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum RefundStatus {
  REQUESTED
  APPROVED
  REJECTED
  PROCESSED
}

enum PromotionTier {
  BASIC
  PREMIUM
  FEATURED
}

enum UserStatus {
  ACTIVE
  PENDING
  BLOCKED
}
